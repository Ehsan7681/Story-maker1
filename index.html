<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <!-- تنظیمات جلوگیری از زوم و نمایش موبایلی -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="StoryMaster: هوش مصنوعی داستان‌نویس حرفه‌ای">
    
    <title>StoryMaster Pro Max</title>

    <!-- اتصال به فایل‌های PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #ec4899;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --bg-input: #f9fafb;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --danger: #ef4444;
            --success: #10b981;
            --radius: 16px;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary: #818cf8;
            --primary-dark: #6366f1;
            --secondary: #f472b6;
            --bg-body: #111827;
            --bg-card: #1f2937;
            --bg-input: #374151;
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --border: #374151;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            transition: background 0.3s ease, color 0.3s ease;
            padding-bottom: 100px;
            /* جلوگیری از رفرش ناخواسته با کشیدن صفحه */
            overscroll-behavior-y: none; 
        }

        /* --- Header --- */
        header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            position: sticky;
            top: 0;
            z-index: 50;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            user-select: none;
        }
        body.dark-mode header { background: rgba(31, 41, 55, 0.85); }

        .logo { font-weight: 900; font-size: 1.4rem; background: linear-gradient(45deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .header-btn {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-main);
            width: 40px; height: 40px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }
        .header-btn:active { transform: scale(0.95); }

        /* --- Container --- */
        .container { max-width: 768px; margin: 20px auto; padding: 0 15px; }

        /* --- Cards --- */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.2s;
        }
        
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
            font-weight: 700; font-size: 1.1rem;
            color: var(--primary);
            user-select: none;
        }

        /* --- Inputs --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: 600; color: var(--text-muted); }
        
        input[type="text"], select, textarea {
            width: 100%;
            padding: 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-main);
            font-family: inherit;
            font-size: 1rem;
            transition: 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2); }

        /* --- Range Slider --- */
        .range-container {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            margin: 0;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px; width: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            cursor: pointer;
            background: var(--border);
            border-radius: 2px;
        }

        .range-value-box {
            background: var(--primary);
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
            white-space: nowrap;
        }

        /* --- API Key List --- */
        .key-item {
            background: var(--bg-input);
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .key-value { flex-grow: 1; font-family: monospace; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .key-actions { display: flex; gap: 5px; }
        .icon-btn {
            width: 32px; height: 32px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.05); color: var(--text-muted);
        }
        .icon-btn:hover { background: rgba(0,0,0,0.1); color: var(--text-main); }
        .icon-btn.delete { color: var(--danger); }
        .icon-btn.delete:hover { background: #fee2e2; }

        /* --- Buttons --- */
        .btn {
            width: 100%; padding: 16px;
            border-radius: 12px; border: none;
            font-weight: 700; font-size: 1rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s;
            touch-action: manipulation; /* جلوگیری از زوم با دابل کلیک */
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text-main); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }

        /* --- Editor Area --- */
        .editor-container { position: relative; }
        #editor { min-height: 350px; line-height: 1.8; resize: vertical; border: 2px solid var(--border); padding: 20px; font-size: 1.05rem; border-radius: 12px; }
        
        .stats-bar {
            display: flex; justify-content: space-between;
            font-size: 0.85rem; color: var(--text-muted);
            margin-top: 10px; padding: 10px;
            background: var(--bg-input); border-radius: 8px;
            border: 1px solid var(--border);
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-box {
            background: var(--bg-card);
            width: 90%; max-width: 450px;
            border-radius: 20px; padding: 25px;
            box-shadow: var(--shadow);
            transform: translateY(20px); transition: 0.3s;
            max-height: 80vh; overflow-y: auto;
        }
        .modal-overlay.active .modal-box { transform: translateY(0); }

        .modal-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 15px; color: var(--text-main); }
        .modal-text { color: var(--text-muted); margin-bottom: 20px; line-height: 1.6; }

        /* --- History List --- */
        .history-item {
            padding: 15px; border-bottom: 1px solid var(--border);
            cursor: pointer; transition: 0.2s;
        }
        .history-item:hover { background: var(--bg-input); }
        .history-meta { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.8rem; color: var(--text-muted); flex-wrap: wrap; gap: 5px; }
        .history-tag { font-size: 0.75rem; padding: 3px 8px; border-radius: 6px; background: var(--bg-input); border: 1px solid var(--border); display: inline-block; }
        
        /* --- Helpers --- */
        .hidden { display: none !important; }
        .loader {
            width: 20px; height: 20px; border: 3px solid #ffffffaa; border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

<header>
    <div class="header-btn" onclick="openHistory()"><i class="fas fa-history"></i></div>
    <div class="logo">StoryMaster <span style="font-size:0.7rem; opacity:0.6; vertical-align: super;">Pro Max</span></div>
    <div class="header-btn" onclick="toggleTheme()"><i class="fas fa-moon" id="themeIcon"></i></div>
</header>

<div class="container">

    <!-- Section 1: API & Config -->
    <div class="card">
        <div class="card-header" onclick="toggleSection('apiBody')" style="cursor: pointer">
            <span><i class="fas fa-fingerprint"></i> مدیریت دسترسی (API)</span>
            <i class="fas fa-chevron-down"></i>
        </div>
        <div id="apiBody" class="hidden">
            <div id="keyList"></div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <input type="text" id="newKeyInput" placeholder="کلید API جدید را اینجا پیست کنید...">
                <button class="btn btn-primary" style="width: auto;" onclick="addNewKey()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
                <label>مدل هوش مصنوعی (بروزرسانی خودکار):</label>
                <div style="display: flex; gap: 10px;">
                    <select id="modelSelect" onchange="saveSelectedModel()">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (پیش‌فرض)</option>
                    </select>
                    <button class="btn btn-outline" style="width: auto;" onclick="fetchModels()" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 2: Story Settings -->
    <div class="card" id="settingsCard">
        <div class="card-header">
            <span><i class="fas fa-compass"></i> تنظیمات داستان</span>
        </div>
        
        <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px; background: rgba(0,0,0,0.03); padding: 8px; border-radius: 8px;">
            <i class="fas fa-info-circle"></i> نکته: برای هر بخش جدید، می‌توانید ژانر، لحن و دستورات را تغییر دهید. سیستم به طور خودکار فصل جدید ایجاد می‌کند.
        </p>

        <div class="input-group">
            <label>موضوع داستان (ثابت):</label>
            <input type="text" id="topic" placeholder="مثلاً: ماجرای یک کارآگاه در تهران ۱۴۵۰...">
        </div>

        <div class="form-grid">
            <div class="input-group">
                <label>ژانر (قابل تغییر):</label>
                <select id="genre">
                    <option value="general">عمومی / آزاد</option>
                    <option value="fantasy">فانتزی و جادویی</option>
                    <option value="scifi">علمی تخیلی (Sci-Fi)</option>
                    <option value="mystery">جنایی و معمایی</option>
                    <option value="horror">ترسناک و دلهره‌آور</option>
                    <option value="romance">عاشقانه و درام</option>
                    <option value="comedy">کمدی و طنز</option>
                    <option value="historical">تاریخی و حماسی</option>
                    <option value="social">اجتماعی و رئال</option>
                    <option value="thriller">هیجانی و اکشن</option>
                </select>
            </div>
            <div class="input-group">
                <label>لحن (قابل تغییر):</label>
                <select id="tone">
                    <option value="formal">رسمی و کتابی</option>
                    <option value="informal">محاوره و صمیمی</option>
                    <option value="slang">لوتی و خیابونی (لاتی)</option>
                    <option value="rude">رک و بی‌پرده (Rude)</option>
                    <option value="dark">تاریک و افسرده</option>
                    <option value="poetic">شاعرانه و ادبی</option>
                    <option value="satire">طنز انتقادی (Satire)</option>
                    <option value="emotional">احساسی و شدید (۱۸+)</option>
                </select>
            </div>
        </div>

        <div class="form-grid">
            <div class="input-group">
                <label>حالت:</label>
                <select id="mode">
                    <option value="ongoing">ادامه‌دار (سریالی)</option>
                    <option value="oneshot">تک قسمتی (کوتاه)</option>
                </select>
            </div>
            <div class="input-group">
                <label>طول این بخش (تعداد کلمات):</label>
                <div class="range-container">
                    <span style="font-size:0.8rem; opacity:0.7">۱۰۰</span>
                    <input type="range" id="length" min="100" max="3000" step="50" value="500" oninput="updateLenVal(this.value)">
                    <div class="range-value-box" id="lenDisplay">500</div>
                </div>
            </div>
        </div>

        <div class="input-group">
            <label>دستورات برای این فصل (قابل تغییر):</label>
            <textarea id="details" rows="2" placeholder="دستور جدید بنویسید (مثلاً: حالا یک شخصیت منفی وارد کن...)"></textarea>
        </div>

        <button class="btn btn-primary" onclick="startStory()" id="startBtn">
            <span class="loader"></span>
            <span>شروع داستان جدید</span>
            <i class="fas fa-rocket"></i>
        </button>
    </div>

    <!-- Section 3: Editor -->
    <div class="card hidden" id="editorCard">
        <div class="card-header">
            <span><i class="fas fa-feather-alt"></i> متن داستان</span>
            <div style="display:flex; gap:5px;">
                <button class="icon-btn" onclick="copyText()" title="کپی"><i class="fas fa-copy"></i></button>
                <button class="icon-btn" onclick="saveStory()" title="ذخیره"><i class="fas fa-save"></i></button>
            </div>
        </div>

        <div class="editor-container">
            <textarea id="editor" placeholder="متن داستان اینجا نوشته می‌شود..."></textarea>
        </div>

        <div class="stats-bar">
            <span>کل کلمات: <b id="totalWords">0</b></span>
            <span>افزوده شده اخیر: <b id="addedWords" style="color:var(--success)">0</b></span>
        </div>

        <div class="form-grid" id="controls" style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="continueStory()" id="continueBtn">
                <span class="loader"></span>
                <span>ادامه داستان (فصل جدید)</span>
                <i class="fas fa-step-forward"></i>
            </button>
            <button class="btn btn-danger" onclick="requestFinish()">
                <span>پایان داستان</span>
                <i class="fas fa-flag-checkered"></i>
            </button>
        </div>
        
        <p id="statusMsg" style="text-align: center; font-size: 0.85rem; color: var(--text-muted); margin-top: 15px;"></p>
    </div>

</div>

<!-- Finish Confirmation Modal -->
<div class="modal-overlay" id="finishModal" onclick="checkClose(event, 'finishModal')">
    <div class="modal-box">
        <div class="modal-title">پایان داستان؟</div>
        <p class="modal-text">شما دکمه پایان را زدید. چطور می‌خواهید داستان را تمام کنید؟</p>
        
        <button class="btn btn-primary" onclick="finishWithEnding()" id="finishWriteBtn" style="margin-bottom: 10px;">
            <span class="loader"></span>
            <span>یک پایان‌بندی جذاب بنویس و تمام کن</span>
        </button>
        
        <button class="btn btn-outline" onclick="finishImmediately()" style="margin-bottom: 10px;">
            <span>همینجا تمام شده اعلام کن</span>
        </button>
        
        <button class="btn" style="background:transparent; color:var(--text-muted)" onclick="closeModal('finishModal')">
            انصراف
        </button>
    </div>
</div>

<!-- History Modal -->
<div class="modal-overlay" id="historyModal" onclick="checkClose(event, 'historyModal')">
    <div class="modal-box">
        <div class="modal-title">کتابخانه داستان‌ها</div>
        <div id="historyList" style="margin-bottom: 20px;"></div>
        <button class="btn btn-danger" onclick="clearHistory()">حذف کل تاریخچه</button>
        <button class="btn" style="margin-top:10px; background:transparent" onclick="closeModal('historyModal')">بستن</button>
    </div>
</div>

<script>
    // --- State ---
    const state = {
        apiKeys: [], // { key: string, visible: boolean }
        keyIndex: 0,
        story: null, // { id, topic, genre, tone, mode, details, len, text, finished, chapterCount }
        history: [],
        theme: 'light'
    };

    // --- Init ---
    document.addEventListener('DOMContentLoaded', async () => {
        loadData();
        renderKeys();
        applyTheme();
        
        if(state.apiKeys.length === 0) {
            document.getElementById('apiBody').classList.remove('hidden');
        } else {
            await fetchModels();
        }

        const savedModel = localStorage.getItem('sm_selected_model');
        if(savedModel) {
            const select = document.getElementById('modelSelect');
            if(select.querySelector(`option[value="${savedModel}"]`)) {
                select.value = savedModel;
            }
        }

        document.getElementById('editor').addEventListener('input', updateStats);
    });

    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW Registered', reg))
                .catch(err => console.log('SW Failed', err));
        });
    }

    function checkClose(e, id) {
        if(e.target.id === id) closeModal(id);
    }

    function updateLenVal(val) {
        document.getElementById('lenDisplay').innerText = val;
    }

    function saveSelectedModel() {
        const val = document.getElementById('modelSelect').value;
        localStorage.setItem('sm_selected_model', val);
    }

    // --- API Management ---
    function addNewKey() {
        const input = document.getElementById('newKeyInput');
        const val = input.value.trim();
        if(!val) return;
        
        state.apiKeys.push({ key: val, visible: false });
        input.value = '';
        saveData();
        renderKeys();
        if(state.apiKeys.length === 1) fetchModels();
    }

    function deleteKey(index) {
        if(confirm('آیا مطمئن هستید که می‌خواهید این کلید را حذف کنید؟')) {
            state.apiKeys.splice(index, 1);
            saveData();
            renderKeys();
        }
    }

    function toggleKeyVis(index) {
        state.apiKeys[index].visible = !state.apiKeys[index].visible;
        renderKeys();
    }

    function copyKey(index) {
        navigator.clipboard.writeText(state.apiKeys[index].key);
        alert('کلید کپی شد');
    }

    function renderKeys() {
        const container = document.getElementById('keyList');
        container.innerHTML = '';
        
        if(state.apiKeys.length === 0) {
            container.innerHTML = '<p style="text-align:center; font-size:0.9rem; opacity:0.7">هنوز کلیدی وارد نشده است.</p>';
            return;
        }

        state.apiKeys.forEach((k, idx) => {
            const div = document.createElement('div');
            div.className = 'key-item';
            
            const displayKey = k.visible ? k.key : '••••••••••••••••••••' + k.key.slice(-4);
            
            div.innerHTML = `
                <div class="key-value">${displayKey}</div>
                <div class="key-actions">
                    <button class="icon-btn" onclick="toggleKeyVis(${idx})"><i class="fas fa-${k.visible ? 'eye-slash' : 'eye'}"></i></button>
                    <button class="icon-btn" onclick="copyKey(${idx})"><i class="fas fa-copy"></i></button>
                    <button class="icon-btn delete" onclick="deleteKey(${idx})"><i class="fas fa-trash"></i></button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // --- Story Logic ---
    async function startStory() {
        if(state.apiKeys.length === 0) return alert('لطفا حداقل یک کلید API وارد کنید.');
        const ui = getUI();
        if(!ui.topic) return alert('موضوع داستان را وارد کنید.');

        state.story = {
            id: Date.now(),
            topic: ui.topic,
            genre: ui.genre,
            tone: ui.tone,
            mode: ui.mode,
            details: ui.details,
            len: ui.len,
            text: '',
            finished: false,
            chapterCount: 1 // Start at chapter 1
        };

        ui.editorCard.classList.remove('hidden');
        ui.editor.value = '';
        ui.addedWords.innerText = '0';
        ui.totalWords.innerText = '0';
        
        ui.editorCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

        updateControls();
        const prompt = buildPrompt('start');
        await callAI(prompt, 'start');
    }

    async function continueStory() {
        // Sync Text
        state.story.text = document.getElementById('editor').value; 
        
        // Update settings dynamically
        const ui = getUI();
        state.story.genre = ui.genre;
        state.story.tone = ui.tone;
        state.story.len = ui.len;
        state.story.details = ui.details;
        state.story.chapterCount = (state.story.chapterCount || 1) + 1; // Increment chapter
        
        saveStory();

        const prompt = buildPrompt('continue');
        await callAI(prompt, 'continue');
    }

    function requestFinish() {
        document.getElementById('finishModal').classList.add('active');
    }

    async function finishWithEnding() {
        closeModal('finishModal');
        state.story.text = document.getElementById('editor').value;
        const prompt = buildPrompt('finish');
        await callAI(prompt, 'finish_write');
    }

    function finishImmediately() {
        closeModal('finishModal');
        state.story.finished = true;
        state.story.text = document.getElementById('editor').value;
        saveStory();
        updateControls();
        alert('داستان پایان‌یافته علامت‌گذاری شد.');
    }

    // --- AI Core ---
    function buildPrompt(action) {
        const s = state.story;
        const currentChap = s.chapterCount || 1;
        
        let p = `You are a creative Persian author.
        Current Settings:
        - Genre: ${s.genre}
        - Tone: ${getToneDesc(s.tone)}
        - Topic: ${s.topic}
        - Specific Instructions for this part: ${s.details}
        - Language: Persian (Farsi) ONLY.
        - Target Length for this part: ~${s.len} words.
        `;

        if(['rude', 'slang', 'adult', 'emotional'].includes(s.tone)) {
            p += `\nSTYLE INSTRUCTION: Write in a raw, unfiltered, ${s.tone} style. Do not be preachy.`;
        }

        const currentText = document.getElementById('editor').value;
        const context = currentText.slice(-6000); 

        if(action === 'start') {
            p += `\nTask: Start the story.`;
            p += `\nIMPORTANT: Start the text with "### فصل ۱: [یک نام جذاب برای این فصل]" and then write the content.`;
            
            if(s.mode === 'oneshot') p += ` Write a complete short story with a conclusion.`;
            else p += ` This is Chapter 1. Do NOT finish the story yet.`;
            
        } else if (action === 'continue') {
            p += `\nStory so far (Context):\n"""${context}"""\n\nTask: Continue the story seamlessly based on the context with the NEW settings.`;
            p += `\nIMPORTANT: Start this new section with "### فصل ${currentChap}: [یک نام جذاب برای این فصل]" and then write the content.`;
        } else if (action === 'finish') {
            p += `\nStory so far:\n"""${context}"""\n\nTask: Write a concluding chapter/scene to finish this story effectively. Wrap up all loose ends.`;
            p += `\nIMPORTANT: Start with "### فصل پایانی: [عنوان]"`;
        }

        return p;
    }

    function getToneDesc(t) {
        const map = {
            'formal': 'Formal, literary, book-like.',
            'informal': 'Casual, spoken style.',
            'slang': 'Street slang (Lati), very informal.',
            'rude': 'Rude, aggressive, direct, offensive style.',
            'dark': 'Dark, gloomy, depressive atmosphere.',
            'poetic': 'Poetic, artistic, maybe rhymed.',
            'satire': 'Satirical, funny but critical.',
            'emotional': 'Highly emotional, romantic, intense.'
        };
        return map[t] || 'Standard';
    }

    async function callAI(prompt, actionType, retryCount = 0) {
        if(retryCount >= state.apiKeys.length) {
            setLoading(false);
            setStatus('خطا: تمام کلیدهای API محدود شده‌اند.', true);
            return;
        }

        const btnId = actionType === 'start' ? 'startBtn' : (actionType === 'finish_write' ? 'finishWriteBtn' : 'continueBtn');
        setLoading(true, btnId);
        setStatus('در حال ارتباط با مغز هوشمند...');

        const apiKey = state.apiKeys[state.keyIndex].key;
        const model = document.getElementById('modelSelect').value || 'gemini-1.5-flash';

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                })
            });

            const data = await res.json();
            
            if(data.error) {
                console.warn(data.error);
                state.keyIndex = (state.keyIndex + 1) % state.apiKeys.length;
                setStatus(`کلید شماره ${retryCount+1} خطا داد. تلاش مجدد...`);
                await callAI(prompt, actionType, retryCount + 1);
            } else {
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if(text) {
                    const editor = document.getElementById('editor');
                    if(editor.value) editor.value += "\n\n" + text;
                    else editor.value = text;
                    
                    const newCount = text.trim().split(/\s+/).length;
                    document.getElementById('addedWords').innerText = newCount;
                    updateStats();
                    
                    state.story.text = editor.value;
                    if(actionType === 'finish_write') {
                        state.story.finished = true;
                        alert('داستان به پایان رسید.');
                    }
                    
                    saveStory();
                    updateControls();
                    setStatus('نوشتن تمام شد.');
                } else {
                    setStatus('متن تولید نشد (احتمالاً فیلتر اخلاقی گوگل).', true);
                }
                setLoading(false, btnId);
            }

        } catch(e) {
            state.keyIndex = (state.keyIndex + 1) % state.apiKeys.length;
            await callAI(prompt, actionType, retryCount + 1);
        }
    }

    // --- UI Helpers ---
    function getUI() {
        return {
            topic: document.getElementById('topic').value,
            genre: document.getElementById('genre').value,
            tone: document.getElementById('tone').value,
            mode: document.getElementById('mode').value,
            details: document.getElementById('details').value,
            len: document.getElementById('length').value,
            editor: document.getElementById('editor'),
            editorCard: document.getElementById('editorCard'),
            totalWords: document.getElementById('totalWords'),
            addedWords: document.getElementById('addedWords')
        };
    }

    function updateStats() {
        const text = document.getElementById('editor').value;
        const count = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
        document.getElementById('totalWords').innerText = count;
    }

    function updateControls() {
        const controls = document.getElementById('controls');
        if(state.story.finished || state.story.mode === 'oneshot') {
            controls.style.display = 'none';
        } else {
            controls.style.display = 'grid';
        }
    }

    function setLoading(isLoading, btnId) {
        const btn = document.getElementById(btnId);
        if(!btn) return;
        
        const loader = btn.querySelector('.loader');
        const icon = btn.querySelector('.fa-rocket') || btn.querySelector('.fa-step-forward') || btn.querySelector('i');
        
        btn.disabled = isLoading;
        if(isLoading) {
            loader.style.display = 'block';
            if(icon) icon.style.display = 'none';
        } else {
            loader.style.display = 'none';
            if(icon) icon.style.display = 'inline-block';
        }
    }

    function setStatus(msg, isError = false) {
        const el = document.getElementById('statusMsg');
        el.innerText = msg;
        el.style.color = isError ? 'var(--danger)' : 'var(--text-muted)';
    }

    function toggleSection(id) {
        document.getElementById(id).classList.toggle('hidden');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    // --- Persistence ---
    function saveData() {
        localStorage.setItem('sm_ultra_keys', JSON.stringify(state.apiKeys));
        localStorage.setItem('sm_ultra_history', JSON.stringify(state.history));
        localStorage.setItem('sm_ultra_theme', state.theme);
    }

    function loadData() {
        state.apiKeys = JSON.parse(localStorage.getItem('sm_ultra_keys') || '[]');
        state.history = JSON.parse(localStorage.getItem('sm_ultra_history') || '[]');
        state.theme = localStorage.getItem('sm_ultra_theme') || 'light';
    }

    function saveStory() {
        if(!state.story) return;
        state.story.text = document.getElementById('editor').value;
        
        const idx = state.history.findIndex(h => h.id === state.story.id);
        if(idx > -1) state.history[idx] = state.story;
        else state.history.unshift(state.story);
        
        saveData();
    }

    function openHistory() {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        
        if(state.history.length === 0) list.innerHTML = '<p style="text-align:center;color:var(--text-muted)">خالی</p>';

        state.history.forEach(s => {
            const item = document.createElement('div');
            item.className = 'history-item';
            
            const statusText = s.finished ? 'پایان یافته' : 'در جریان';
            const statusColor = s.finished ? 'var(--success)' : 'var(--primary)';
            const chapters = s.chapterCount || 1;
            
            // Format Date & Time
            const dateObj = new Date(s.id);
            const dateStr = dateObj.toLocaleDateString('fa-IR');
            const timeStr = dateObj.toLocaleTimeString('fa-IR', {hour: '2-digit', minute:'2-digit'});

            item.innerHTML = `
                <div style="font-weight:bold; font-size:1rem;">${s.topic}</div>
                <div class="history-meta">
                    <span class="history-tag" style="color:${statusColor}; border-color:${statusColor}">${statusText}</span>
                    <span class="history-tag">${chapters} فصل</span>
                    <span><i class="far fa-clock"></i> ${dateStr} - ${timeStr}</span>
                </div>
            `;
            item.onclick = () => loadHistoryItem(s);
            list.appendChild(item);
        });

        document.getElementById('historyModal').classList.add('active');
    }

    function loadHistoryItem(s) {
        state.story = s;
        document.getElementById('topic').value = s.topic;
        document.getElementById('genre').value = s.genre;
        document.getElementById('tone').value = s.tone;
        document.getElementById('mode').value = s.mode;
        document.getElementById('details').value = s.details;
        document.getElementById('editor').value = s.text;
        
        document.getElementById('editorCard').classList.remove('hidden');
        document.getElementById('editorCard').scrollIntoView();
        
        closeModal('historyModal');
        updateStats();
        updateControls();
    }
    
    function clearHistory() {
        if(confirm('حذف کامل تاریخچه؟')) {
            state.history = [];
            saveData();
            openHistory(); 
        }
    }

    function copyText() {
        document.getElementById('editor').select();
        document.execCommand('copy');
        alert('کپی شد!');
    }

    // --- Theme & Models ---
    function toggleTheme() {
        state.theme = state.theme === 'light' ? 'dark' : 'light';
        saveData();
        applyTheme();
    }

    function applyTheme() {
        const icon = document.getElementById('themeIcon');
        if(state.theme === 'dark') {
            document.body.classList.add('dark-mode');
            icon.className = 'fas fa-sun';
        } else {
            document.body.classList.remove('dark-mode');
            icon.className = 'fas fa-moon';
        }
    }

    async function fetchModels() {
        if(state.apiKeys.length === 0) return;
        const btn = document.getElementById('refreshBtn');
        const sel = document.getElementById('modelSelect');
        
        btn.disabled = true;
        btn.innerHTML = '<div class="loader" style="width:15px;height:15px;display:block;border-color:#333"></div>';
        
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${state.apiKeys[0].key}`);
            const data = await res.json();
            
            const currentSelection = sel.value;
            sel.innerHTML = '';
            
            data.models.filter(m => m.supportedGenerationMethods.includes("generateContent")).forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.name.replace('models/', '');
                opt.text = m.displayName;
                if(m.name.includes('flash')) opt.selected = true;
                sel.appendChild(opt);
            });

            if(currentSelection && sel.querySelector(`option[value="${currentSelection}"]`)){
                sel.value = currentSelection;
            }

        } catch(e) {
            console.error('Auto fetch failed', e);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sync-alt"></i>';
        }
    }
</script>

</body>
</html>


